#' Create a worker object for use as a worker with master objects generated by [QueryCountMaster()]
#' @description `QueryCountWorker` objects are worker objects at each site of
#' a distributed QueryCount model computation
#' @docType class
#' @seealso [QueryCountMaster()] which goes hand-in-hand with this object
#' @importFrom R6 R6Class
#' @section Methods:
#'
#' \describe{
#'   \item{`QueryCountWorker$new(defn, data)`}{Create a new QueryCount worker object with given definition defn, data and flag for preserving state between iterations}
#'   \item{`kosher()`}{Check if inputs and state of object are sane. For future use}
#'   \item{`getStateful()`}{Returns `FALSE`}
#' }
#'
#' @import rlang
#' @importFrom dplyr filter
#' @importFrom magrittr %>%
#' @export
#' @format An [R6::R6Class()] generator object
QueryCountWorker <- R6Class(
    "QueryCountWorker"
  , private = list(
        defn = NA
      , data = NA
      , stateful = FALSE
    )
  , public = list(
        initialize = function(defn, data, stateful = FALSE) {
            private$defn  <- defn
            private$data  <- data
            private$stateful <- FALSE
            stopifnot(self$kosher())
        }, getStateful = function() {
            private$stateful
        }, kosher = function() {
            TRUE
        }, queryCount = function() {
            data  <- private$data
            filter_expr  <- eval(parse(text = paste("rlang::expr(", private$defn$filterCondition, ")")))
            data %>%
                dplyr::filter(!! filter_expr) %>%
                nrow()
        }
    )
)

#' Create a master object to control worker objects generated by [QueryCountWorker()]
#' @description `QueryCountMaster` objects instantiate and run a distributed QueryCount computation
#' @docType class
#' @seealso [QueryCountWorker()] which goes hand-in-hand with this object
#' @importFrom R6 R6Class
#' @section Methods:
#'
#' \describe{
#'   \item{`QueryCountMaster$new(defn, debug = FALSE)`}{Create an QueryCount master object
#'         with the specified computation definition. The debug flag is used for debugging computations}
#'   \item{`kosher()`}{Check if inputs and state of object are sane. For future use}
#'   \item{`run()`}{Run the QueryCount computation until either the
#'         threshold is reached or the max.iter number of iterations are used up}
#'   \item{`summary()`}{Return the summary of results}
#' }
#' @export
#' @format An [R6::R6Class()] generator object
QueryCountMaster <- R6Class(
    "QueryCountMaster",
    private = list(
        defn = NA,
        dry_run = FALSE,
        sites = list(),
        mapFn = function(site) {
            payload <- list(objectId = site$instanceId,
                            method = "queryCount")
            q <- POST(.makeOpencpuURL(urlPrefix=site$url, fn="executeMethod"),
                      body = toJSON(payload),
                      add_headers("Content-Type" = "application/json"),
                      config = getConfig()$sslConfig
                      )
            ## Should really examine result here.
            .deSerialize(q)
        },
        result = list(),
        debug = FALSE
    ),
    public = list(
        initialize = function(defn, debug = FALSE) {
            'Initialize the object with a dataset'
            private$defn <- defn
            private$debug <- debug
            stopifnot(self$kosher())
        },
        kosher = function() {
            ' Check for appropriateness'
            TRUE
        }, queryCount = function() {
            'Compute the (partial) log-likelihood on all data'
            sites <- private$sites
            n <- length(sites)
            if (private$dry_run) {
                mapFn <- function(x) x$worker$queryCount()
            } else {
                mapFn <- private$mapFn
            }
            results <- Map(mapFn, sites)
            value <- Reduce(f = sum, results)
            if (private$debug) {
                print("value")
                print(value)
            }
            value
        },
        addSite = function(name, url = NULL, worker = NULL) {
            ## critical section start
            ## This is the time to cache "p" and check it
            ## against all added sites
            ## Only one of url/worker should be non-null
            stopifnot(is.null(url) || is.null(worker))
            n <- length(private$sites)
            if (is.null(url)) {
                private$dry_run <- private$dry_run || TRUE
                private$sites[[n+1]] <- list(name = name, worker = worker)
            } else {
                localhost <- (grepl("^http://localhost", url) ||
                              grepl("^http://127.0.0.1", url))
                private$sites[[n+1]] <- list(name = name, url = url,
                                             localhost = localhost,
                                             dataFileName = if (localhost) paste0(name, ".rds") else NULL)
            }
            ## critical section end
        },
        run = function() {
            'Run Computation'
            dry_run <- private$dry_run
            defn <- private$defn
            debug <- private$debug
            n <- length(sites)
            if (debug) {
                print("run(): checking worker object creation")
            }
            if (dry_run) {
                ## Workers have already been created and passed
                sites <- private$sites
            } else {
                ## Create an instance Id
                ## Make remote call to instantiate workers
                instanceId <- generateId(object=list(Sys.time(), self))
                ## Augment each site with object instance ids
                private$sites <- sites <- lapply(private$sites,
                                                 function(x) list(name = x$name,
                                                                  url = x$url,
                                                                  localhost = x$localhost,
                                                                  dataFileName = x$dataFileName,
                                                                  instanceId = if (x$localhost) x$name else instanceId))
                sitesOK <- sapply(sites,
                                  function(x) {
                                      payload <- if (is.null(x$dataFileName)) {
                                                     list(defnId = defn$id, instanceId = x$instanceId)
                                                 } else {
                                                     list(defnId = defn$id, instanceId = x$instanceId,
                                                          dataFileName = x$dataFileName)
                                                 }
                                      q <- POST(url = .makeOpencpuURL(urlPrefix=x$url, fn="createInstanceObject"),
                                                body = toJSON(payload),
                                                add_headers("Content-Type" = "application/json"),
                                                config = getConfig()$sslConfig
                                                )
                                      .deSerialize(q)
                                  })

                ## Stop on error
                if (!all(sitesOK)) {
                    stop("run():  Some sites did not respond successfully!")
                    sites <- sites[which(sitesOK)]  ## Only use sites that created objects successfully.
                }
            }
            private$result  <- result  <- self$queryCount()

            if (!dry_run) {
                if (debug) {
                    print("run(): checking worker object cleanup")
                }
                sitesOK <- sapply(sites,
                                  function(x) {
                                      payload <- list(instanceId = x$instanceId)
                                      q <- POST(url = .makeOpencpuURL(urlPrefix=x$url, fn="destroyInstanceObject"),
                                                body = toJSON(payload),
                                                add_headers("Content-Type" = "application/json"),
                                                config=getConfig()$sslConfig
                                                )
                                      .deSerialize(q)
                                  })
                if (!all(sitesOK)) {
                    warning("run():  Some sites did not clean up successfully!")
                }
            }
            result
        },
        summary = function() {
            'Return the summary'
            result <- private$result
            if (length(result) == 0) {
                stop ("Run the computation first using run()")
                result <- private$result
            }
            result
        }
    )
)

